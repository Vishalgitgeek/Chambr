{% extends 'core/base.html' %}

{% block content %}

<!-- Room Header Section -->
<div class="room-header bg-gradient-dark text-white p-4 mb-4 rounded-3">
    <div class="container-fluid">
        <div class="row align-items-center">
            <div class="col-md-8">
                <div class="d-flex align-items-center mb-2">
                    <div class="room-icon me-3">
                        <i class="fas fa-door-open fa-2x"></i>
                    </div>
                    <div>
                        <h1 class="mb-1">{{ room.name }}</h1>
                        <div class="room-meta d-flex flex-wrap gap-3">
                            <span class="badge bg-success bg-opacity-90 px-3 py-2">
                                <i class="fas fa-tag me-1"></i>{{ room.topic.name }}
                            </span>
                            <span class="badge bg-info bg-opacity-90 px-3 py-2">
                                <i class="fas fa-user-crown me-1"></i>Host: {{ room.host.username }}
                            </span>
                            <span class="badge bg-warning bg-opacity-90 px-3 py-2 text-dark">
                                <i class="fas fa-clock me-1"></i>{{ room.created_at|timesince }} ago
                            </span>
                        </div>
                    </div>
                </div>
                {% if room.description %}
                    <p class="mb-0 opacity-90 fs-6">
                        <i class="fas fa-info-circle me-2"></i>{{ room.description }}
                    </p>
                {% endif %}
            </div>
            <div class="col-md-4 text-md-end mt-3 mt-md-0">
                <div class="room-stats">
                    <div class="stat-item mb-2">
                        <span class="stat-number">{{ participants.count }}</span>
                        <span class="stat-label">Participants</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number">{{ posts.count }}</span>
                        <span class="stat-label">Messages</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row g-4">
    <!-- Left Column: Posts & Messaging -->
    <div class="col-lg-8">
        <!-- Message Input Section -->
        {% if user.is_authenticated %}
            <div class="message-input-card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-pen me-2"></i>Share your thoughts
                    </h5>
                </div>
                <div class="card-body p-4">
                    <form method="POST" enctype="multipart/form-data" class="message-form">
                        {% csrf_token %}
                        <div class="mb-3">
                            <div class="user-avatar-input d-flex align-items-start">
                                {% if user.profile.profile_picture %}
                                    <img src="{{ user.profile.profile_picture.url }}" alt="Your Avatar" class="rounded-circle me-3" width="45" height="45" style="object-fit: cover;">
                                {% else %}
                                    <img src="{{ MEDIA_URL }}usr-profile.png" alt="Default Avatar" class="rounded-circle me-3" width="45" height="45" style="object-fit: cover;">
                                {% endif %}
                                <div class="flex-grow-1">
                                    <textarea name="content" class="form-control message-textarea" rows="3" placeholder="What's on your mind, {{ user.username }}?"></textarea>
                                </div>
                            </div>
                        </div>
                        
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="file-input-wrapper">
                                <input type="file" name="image" id="imageInput" class="d-none" accept="image/*">
                                <label for="imageInput" class="btn btn-outline-secondary btn-sm">
                                    <i class="fas fa-image me-1"></i>Add Image
                                </label>
                                <span id="fileName" class="text-muted small ms-2"></span>
                            </div>
                            <button type="submit" class="btn btn-primary btn-sm px-4">
                                <i class="fas fa-paper-plane me-1"></i>Send
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        {% else %}
            <div class="auth-prompt-card mb-4">
                <div class="card-body text-center p-5">
                    <i class="fas fa-lock fa-3x text-muted mb-3"></i>
                    <h4 class="text-muted mb-3">Join the Conversation</h4>
                    <p class="text-muted mb-4">Sign in to participate in this room and share your thoughts with the community.</p>
                    <a href="{% url 'login' %}" class="btn btn-primary btn-lg me-2">
                        <i class="fas fa-sign-in-alt me-2"></i>Login
                    </a>
                    <a href="{% url 'register' %}" class="btn btn-outline-primary btn-lg">
                        <i class="fas fa-user-plus me-2"></i>Register
                    </a>
                </div>
            </div>
        {% endif %}

        <!-- Posts Section -->
        <div class="posts-section">
            <div class="section-header d-flex justify-content-between align-items-center mb-4">
                <h4 class="mb-0">
                    <i class="fas fa-comments me-2 text-primary"></i>
                    Recent Messages
                </h4>
                <span class="badge bg-light text-dark px-3 py-2">
                    {{ posts.count }} message{{ posts.count|pluralize }}
                </span>
            </div>

            <div class="posts-container">
                {% for post in posts %}
                    <div class="post-card mb-3" data-post-id="{{ post.id }}">
                        <div class="card-body p-4">
                            <!-- Post Header -->
                            <div class="post-header d-flex align-items-center mb-3">
                                {% if post.user.profile.profile_picture %}
                                    <img src="{{ post.user.profile.profile_picture.url }}" alt="Profile Picture" class="post-avatar rounded-circle me-3" width="45" height="45" style="object-fit: cover;">
                                {% else %}
                                    <img src="{{ MEDIA_URL }}usr-profile.png" alt="Default Avatar" class="post-avatar rounded-circle me-3" width="45" height="45" style="object-fit: cover;">
                                {% endif %}
                                <div class="flex-grow-1">
                                    <div class="d-flex align-items-center gap-2">
                                        <a href="{% url 'profile' post.user.username %}" class="post-username fw-semibold text-dark text-decoration-none">
                                            {{ post.user.username }}
                                        </a>
                                        {% if post.user == room.host %}
                                            <span class="badge bg-warning bg-opacity-75 text-dark">
                                                <i class="fas fa-crown"></i> Host
                                            </span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Post Content -->
                            {% if post.content %}
                                <div class="post-content mb-3">
                                    <p class="mb-0">{{ post.content|linebreaks }}</p>
                                </div>
                            {% endif %}
                            
                            <!-- Post Image -->
                            {% if post.image %}
                                <div class="post-image mb-3">
                                    <img src="{{ post.image.url }}" class="img-fluid rounded-3 shadow-sm post-img" alt="Post Image" />
                                </div>
                            {% endif %}
                            
                            <!-- Post Actions -->
                            <div class="post-actions d-flex justify-content-between align-items-center">
                                <div class="post-time text-muted small">
                                    {{ post.created_at|date:"M d, Y - H:i" }}
                                </div>
                            </div>
                        </div>
                    </div>
                {% empty %}
                    <div class="empty-posts text-center py-5">
                        <i class="fas fa-comments fa-4x text-muted opacity-50 mb-3"></i>
                        <h4 class="text-muted mb-3">No messages yet</h4>
                        <p class="text-muted">Be the first to start the conversation in this room!</p>
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Right Column: Participants Sidebar -->
    <div class="col-lg-4">
        <div class="participants-card sticky-top" style="top: 1rem;">
            <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-users me-2"></i>Participants
                </h5>
                <span class="badge bg-primary">{{ participants.count }}</span>
            </div>
            <div class="participants-body">
                {% for participant in participants %}
                    <div class="participant-item">
                        <div class="d-flex align-items-center">
                            <div class="participant-avatar position-relative">
                                {% if participant.profile.profile_picture %}
                                    <img src="{{ participant.profile.profile_picture.url }}" alt="Profile Picture" class="rounded-circle" width="45" height="45" style="object-fit: cover;">
                                {% else %}
                                    <img src="{{ MEDIA_URL }}usr-profile.png" alt="Default Avatar" class="rounded-circle" width="45" height="45" style="object-fit: cover;">
                                {% endif %}
                                <div class="online-indicator"></div>
                            </div>
                            <div class="participant-info flex-grow-1 ms-3">
                                <a href="{% url 'profile' participant.username %}" class="participant-name fw-semibold text-dark text-decoration-none d-block">
                                    {{ participant.username }}
                                </a>
                                {% if participant == room.host %}
                                    <span class="badge bg-warning bg-opacity-75 text-dark">
                                        <i class="fas fa-crown"></i> Room Host
                                    </span>
                                {% else %}
                                    <small class="text-muted">Member</small>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                {% empty %}
                    <div class="text-center py-4 text-muted">
                        <i class="fas fa-user-slash fa-2x mb-2"></i>
                        <p class="mb-0">No participants yet</p>
                    </div>
                {% endfor %}
            </div>
            
            {% if user.is_authenticated and user not in participants %}
                <div class="card-footer bg-light">
                    <div class="d-grid">
                        <button class="btn btn-primary btn-sm">
                            <i class="fas fa-user-plus me-1"></i>Join Room
                        </button>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<style>
/* Room Header Styling */
.room-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    border: none;
}

.room-icon {
    background: rgba(255,255,255,0.2);
    padding: 15px;
    border-radius: 50%;
    backdrop-filter: blur(10px);
}

.room-stats .stat-item {
    text-align: center;
}

.room-stats .stat-number {
    display: block;
    font-size: 2rem;
    font-weight: bold;
    line-height: 1;
}

.room-stats .stat-label {
    font-size: 0.9rem;
    opacity: 0.8;
}

/* Message Input Card */
.message-input-card {
    background: white;
    border-radius: 15px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.08);
    border: 1px solid rgba(0,0,0,0.05);
    overflow: hidden;
}

.message-textarea {
    border: 2px solid #e9ecef;
    border-radius: 10px;
    resize: none;
    transition: all 0.3s ease;
}

.message-textarea:focus {
    border-color: #0d6efd;
    box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
}

/* Auth Prompt Card */
.auth-prompt-card {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-radius: 15px;
    border: 1px solid rgba(0,0,0,0.05);
}

/* Posts Styling */
.post-card {
    background: white;
    border-radius: 15px;
    box-shadow: 0 3px 15px rgba(0,0,0,0.05);
    border: 1px solid rgba(0,0,0,0.03);
    transition: all 0.3s ease;
}

.post-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.1);
}

.post-username:hover {
    color: #0d6efd !important;
}

.post-content {
    font-size: 1rem;
    line-height: 1.6;
    color: #333;
}

.post-img {
    max-height: 400px;
    object-fit: cover;
    cursor: pointer;
    transition: transform 0.3s ease;
}

.post-img:hover {
    transform: scale(1.02);
}

.btn-reaction {
    border: none;
    padding: 0.4rem 0.8rem;
    margin-right: 0.5rem;
    transition: all 0.3s ease;
}

.btn-reaction:hover {
    transform: translateY(-1px);
}

/* Participants Sidebar */
.participants-card {
    background: white;
    border-radius: 15px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.08);
    border: 1px solid rgba(0,0,0,0.05);
    overflow: hidden;
}

.participants-body {
    max-height: 500px;
    overflow-y: auto;
    padding: 0;
}

.participant-item {
    padding: 1rem;
    border-bottom: 1px solid rgba(0,0,0,0.05);
    transition: background-color 0.3s ease;
}

.participant-item:hover {
    background-color: rgba(0,0,0,0.02);
}

.participant-item:last-child {
    border-bottom: none;
}

.online-indicator {
    position: absolute;
    bottom: 2px;
    right: 2px;
    width: 12px;
    height: 12px;
    background: #28a745;
    border: 2px solid white;
    border-radius: 50%;
    animation: pulse-online 2s infinite;
}

@keyframes pulse-online {
    0% { opacity: 1; }
    50% { opacity: 0.5; }
    100% { opacity: 1; }
}

.participant-name:hover {
    color: #0d6efd !important;
}

/* Empty States */
.empty-posts {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-radius: 15px;
    margin: 2rem 0;
}

/* File Input Styling */
.file-input-wrapper {
    position: relative;
}

#fileName {
    max-width: 150px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

/* Responsive Design */
@media (max-width: 768px) {
    .room-header {
        padding: 2rem 1rem;
    }
    
    .room-header h1 {
        font-size: 1.5rem;
    }
    
    .post-card {
        margin-bottom: 1rem;
    }
    
    .participants-card {
        margin-top: 2rem;
        position: relative !important;
        top: auto !important;
    }
    
    .room-stats {
        display: flex;
        gap: 2rem;
        justify-content: center;
    }
}

/* Scrollbar Styling */
.participants-body::-webkit-scrollbar {
    width: 6px;
}

.participants-body::-webkit-scrollbar-track {
    background: #f1f1f1;
}

.participants-body::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 3px;
}

.participants-body::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
}

/* Animation for new posts */
.post-card {
    animation: fadeInUp 0.5s ease-out;
}

@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}
</style>

<script>
// File input handling
document.getElementById('imageInput').addEventListener('change', function(e) {
    const fileName = document.getElementById('fileName');
    if (e.target.files.length > 0) {
        fileName.textContent = e.target.files[0].name;
    } else {
        fileName.textContent = '';
    }
});

// Post image modal (optional enhancement)
document.querySelectorAll('.post-img').forEach(img => {
    img.addEventListener('click', function() {
        // Could add image modal/lightbox here
        window.open(this.src, '_blank');
    });
});
</script>

<!-- Font Awesome for icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

{% endblock %}